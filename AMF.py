import requests
import pyamf
from pyamf import remoting
import ChecksumCalculator
import json

class AMF:

    Endpoint = ""
    SessionId = ""

    def GetEndpointForServer(Server):
        endpointresponse = requests.get("https://disco.mspapis.com/disco/v1/services/msp/" + Server + "?services=mspwebservice", verify=False)
        AMF.Endpoint = endpointresponse.json()["Services"][0]["Endpoint"]
    def SendAMF(Method, Req, DecodeAmf = True, ChecksumReq = None, Ticket = ""):
        req = remoting.Request(target=Method, body=Req)
        ev = remoting.Envelope(pyamf.AMF3)    
        ev.headers["sessionID"] = AMF.SessionId
        if ChecksumReq is None:
            ev.headers["id"] = ChecksumCalculator.ChecksumCalculator.createChecksum(Req)
        else:
            ev.headers["id"] = ChecksumCalculator.ChecksumCalculator.createChecksum(ChecksumReq, Ticket)
        ev.headers["needClassName"] = True
        ev['/1'] = req

        # Encode request 
        bin_msg = remoting.encode(ev)

        # Send request; You can use other channels like RTMP
        resp = requests.post(AMF.Endpoint + "/Gateway.aspx?method=" + Method, 
                            data=bin_msg.getvalue(), 
                            headers={'Content-Type': 'application/x-amf', 'Referer': 'https://elixzz.fr'},
                            verify= False)
        # Decode response
        resp_msg = resp.content
        if DecodeAmf:
            resp_msg = AMF.DecodeAMF(resp.content)
        return resp_msg
    def DecodeAMF(resp):
        resp_msg = remoting.decode(resp)
        return json.loads(str(resp_msg.bodies[0][1]).replace("<Response status=/onResult>", "").replace("</Response>", "").replace("'", '"').replace('),', '",').replace("datetime.datetime(", '"').replace("None", "null").replace("True", "true").replace("False", "false").replace('[{"FeatureId": 1, "Name": "GIVE_GIFT", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 3, "Name": "FAME_MAGAZINE", "Platforms": "flex.messaging.io.ArrayCollection [0]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 4, "Name": "CREATE_AND_RATE", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 5, "Name": "CREATE_AND_RATE_SUBMIT", "Platforms": "flex.messaging.io.ArrayCollection [0]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 6, "Name": "HIGHSCORES", "Platforms": "flex.messaging.io.ArrayCollection [1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 7, "Name": "MOVIES", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 8, "Name": "YOUTUBE_V2", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 9, "Name": "SAVE_SNAPSHOT_ON_ENTER_ROOM", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 10, "Name": "MY_PROFILE_V2", "Platforms": "flex.messaging.io.ArrayCollection [1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 11, "Name": "MOVIE_EDITOR", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 12, "Name": "DEFAULT_ACTION_MENU", "Platforms": "flex.messaging.io.ArrayCollection [1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 13, "Name": "CHATROOM_ACTION_MENU", "Platforms": "flex.messaging.io.ArrayCollection [1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 14, "Name": "INCENTIVIZED_ADVERTISEMENT", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 15, "Name": "ACTOR_BLOCK_RELOAD_MOBILE", "Platforms": "flex.messaging.io.ArrayCollection [1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 17, "Name": "EXTENDED_GIFTING", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 19, "Name": "WALLPOST_LIKES_IN_DYNAMODB", "Platforms": "flex.messaging.io.ArrayCollection [1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 20, "Name": "VPAID_LOADER_CONTEXT", "Platforms": "flex.messaging.io.ArrayCollection [0]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 22, "Name": "MOVIESTUDIO_ADD_SCENES", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 23, "Name": "NUDGE_SERVICE", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 24, "Name": "PushNotification", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 25, "Name": "ARTBOOK_ANIMATED_ITEMS", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 26, "Name": "FORCE_TOKEN_VERIFICATION_EMAIL", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 27, "Name": "ADVANCED_INTERNET_CONNECTIVITY_MANAGEMENT", "Platforms": "flex.messaging.io.ArrayCollection [1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 28, "Name": "SHOW_ONE_TO_ONE_CHAT_IN_GROUP_CHAT", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 31, "Name": "SEND_FATAL_REPORTS_FOR_WEB", "Platforms": "flex.messaging.io.ArrayCollection [0]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 34, "Name": "WHEEL_OF_FORTUNE_IMPROVEMENTS_S57", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 35, "Name": "OPTIMIZED_ANIMATIONS", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 36, "Name": "FAME_WHEEL_MOBILE", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 37, "Name": "USE_PESOS_FOR_BOKU", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 38, "Name": "USE_PESOS_FOR_MOBILE", "Platforms": "flex.messaging.io.ArrayCollection [1, 2]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 40, "Name": "USE_PESOS_FOR_PAYPAL", "Platforms": "flex.messaging.io.ArrayCollection [0]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 41, "Name": "USE_PESOS_FOR_SOFORT", "Platforms": "flex.messaging.io.ArrayCollection [0]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 42, "Name": "USE_PESOS_FOR_PAYSAFECARD", "Platforms": "flex.messaging.io.ArrayCollection [0]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 43, "Name": "USE_PESOS_FOR_ECARD", "Platforms": "flex.messaging.io.ArrayCollection [0]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 44, "Name": "USE_PESOS_FOR_IDEAL", "Platforms": "flex.messaging.io.ArrayCollection [0]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 45, "Name": "USE_PESOS_FOR_RECURRING_PAYMENTS", "Platforms": "flex.messaging.io.ArrayCollection [0]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 46, "Name": "USE_PESOS_FOR_SPECIAL_OFFER", "Platforms": "flex.messaging.io.ArrayCollection [0]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 47, "Name": "SEND_ACTOR_MINIMAL", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 48, "Name": "USE_PESOS_FOR_DANKORT", "Platforms": "flex.messaging.io.ArrayCollection [0]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 49, "Name": "USE_PESOS_FOR_CARTE_BANCAIRE", "Platforms": "flex.messaging.io.ArrayCollection [0]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 50, "Name": "USE_PESOS_FOR_CARDS", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 51, "Name": "USE_NEBULA_PROFILE_ID_FOR_PAYMENTS", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 52, "Name": "USE_NEBULA_FOR_BLOCKED_AND_BLOCKING_ACTORS", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 53, "Name": "NEBULA_MESSAGE_HISTORY_READING", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 54, "Name": "PRESENCE_TOKEN_ENABLED", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 55, "Name": "NEBULA_LOGIN_REQUIRED", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}, {"FeatureId": 56, "Name": "READ_NEBULA_NOTIFICATIONS_ENABLED", "Platforms": "flex.messaging.io.ArrayCollection [0, 1, 2, 3]", "AMF_CLASSNAME": "MovieStarPlanet.Model.Features.ValueObjects.FeatureVO"}]"', '"').replace("<flex.messaging.io.ArrayCollection [{", "[{").replace("}]>", "}]").replace('<', '"').replace('>', '"'))